# CloudFrontについて
## 概要
静的及び動的なウェブコンテンツの配信速度を高速化できるサービス。<br /> CloudFrontは"エッジロケーション"と呼ばれる世界中のネットワークを経由して、ウェブコンテンツを配信する。<br />
CloudFrontでサービスを提供しているコンテンツをユーザーがリクエストすると、リクエストは"エッジローケーション"にルーティングされ、レイテンシー（ファイルの最初のバイトがロードされるまでの時間）を最小限にすることが可能。<br />


コンテンツをリクエストした際に、そのコンテンツがエッジロケーションに最も低いレイテンシーですでに存在している場合、CloudFrontはそのエッジロケーションから、すでに存在しているコンテンツを配信することで低いレイテンシーでユーザーにコンテンツを配信することができる。<br />


コンテンツがこのエッジロケーションに存在しない場合はコンテンツの最新バージョンをオリジン（S3バケットまたはHTTPサーバーなど）からコンテンツを取り込む。<br />


## 主なユースケース

### 静的ウェブサイトのコンテンツ配信
CloudFrontを使用することでエッジロケーションの利点を活用し、静的ウェブサイトのコンテンツ（画像、CSS、JavaScriptなど）配信を高速化する。<br />
S3バケットに静的コンテンツを簡単に格納できるため、S3からコンテンツを配信することができる。<br />


### ビデオの配信
CloudFrontを使用することで"録画済みの動画ファイル"及び"ライブイベントの動画"をストリーム配信するためのいくつかのオプションが提供される。<br />
オンデマンドビデオ（VOD）ストリーミングではあらゆる動画ファイルの形式（MPEG DASH、Apple HLS、Microsoft Smooth Streaming、CMAFなど）で、様々なデバイスにビデオストリーミング配信が可能になる。<br />


## コンテンツ配信の設定方法
"CloudFront ディストリビューション"を作成することでコンテンツ配信する場所、およびコンテンツ配信の追跡など、詳細な設定をCloudFrontに対して指示することが可能。<br />
これによりユーザーがコンテンツを表示する際にCloudFrontはビュワーに近いエッジサーバーからコンテンツを早く配信することができる。<br />

[![Image from Gyazo](https://i.gyazo.com/4357a8259553a37c20b465299fa10e6f.png)](https://gyazo.com/4357a8259553a37c20b465299fa10e6f)<br />


### CloudFrontでコンテンツ配信する方法
1) オリジンサーバ（S3バケットまたはHTTPサーバなど）を指定する。<br />
そしてオリジンサーバからCloudFrontがオブジェクトを取得し、エッジロケーションから全世界に配信される。<br />
その際にオリジンサーバにはオブジェクトの最終リージョンが保存される。<br />


2) オブジェクトをオリジンサーバーにアップロードする。<br />
オブジェクトはHTTP経由で提供できるものであれば何でも構わない。<br />
通常ではウェブページ、画像メディアファイルがオブジェクトになりえる。<br />


S3バケットをオリジンサーバーとして使用している場合はバケット内のオブジェクトを"読み取り可能にして公開する"ことでオブジェクトのCloudFront URLを知っているユーザーなら誰でもそのオブジェクトにアクセスできる。<br />

一方でオブジェクトを非公開にして"署名付きURL"または"署名付きCookie"を使用することでオブジェクトにアクセスするユーザーを制限することもできる。<br />


3)CLoudFrontディストリビューションを作成する。<br />
このディストリビューションを作成する。<br />
このディストリビューションの設定によりユーザーがウェブサイトまたはアプリケーションを通じてファイルをリクエストした時に、どのオリジンサーバからオブジェクトを取得するかがCloudFrontによって指示される。<br />

4)新しいディストリビューションにドメイン名を割り当てる。<br />


5) CloudFrontはディストリビューションの構成を関係する全てのエッジロケーション、またはポイントオブプレゼンス（POP）（CloudFrontがファイルのコピーをキャッシュするために使用する、地理的に分散して配置されたデータセンター内のサーバ群）に送信する。<br />
ただし、ディストリビューションのコンテンツは送信されない。<br />


なお、CloudFrontがディストリビューションのドメイン名としてd111111XXXXXXX.cloudfront.net を返した場合は、S3 バケット内または HTTP サーバーのルートディレクトリに存在する top.jpg の URL は “http://d111111XXXXXXX.cloudfront.net/top.jpg” となる。<br />


または、独自ドメイン名（sunnycloud.jpなど）をディストリビューションにしようするようCloudFrontに設定することも可能。<br />
この場合のURLは"http://www.sunnycloud.jp/top.jpg"のように設定することも可能。<br />


## 主なキャッシュの仕組み
### エッジロケーションにおけるキャッシュの仕組み

オリジンサーバが直接応答するリクエストの数を減らすためにCloudFrontキャッシュを使用する。<br />
CloudFrontキャッシュはユーザーに近いエッジロケーションからオブジェクトを提供する。<br />
これによりオリジンサーバの負荷が軽減され、レイテンシーが減少する。<br />


### キャッシュヒット率とは

すべてのリクエスト数に対するCloudFrontキャッシュから直接オブジェクトを提供するリクエストの比率を"キャッシュヒット率"という。<br />


### キャッシュヒット率の向上

コンテンツのオリジンサーバにアクセスするのではなく、CloudFrontキャッシュから直接提供されるビュワーリクエストの比率を増やしてパフォーマンスを向上させることができる。<br />
キャッシュヒット率を向上させるにはオブジェクトに対して、"Cache-Control max-age"または"Cache-Control s-maxage"ディレクティブを指定することで、max-ageまたはs-maxageに対して最も長い実用的な値を指定するようにオリジンを設定することが可能。<br />


また、キャッシュ期間が短ければ短いほど、オブジェクトが更新されているかどうかを特定して、最新バージョンを取得するリクエストをCloudFrontがオリジンサーバに送信する頻度が高くなる。<br />


## 参考文献
[SunnyCloud](https://www.sunnycloud.jp/column/20210614-01/)<br />
