# VPCについて

## 基本機能

### クラウドに仮想ネットワークを構築
Amazon VPC(Virtual Private Cloud)は、その名のとおりユーザー専用のプライベートなクラウド環境を提供するサービス。<br />

VPCは、1つのTCP/IPネットワーク全体をサービス名と同じVPCという単位で管理する。<br />
VPCはAWSリージョンごとに作成し、VPC間は他のサービスを利用しない限り独立しており、VPC同士の通信はできない。<br />

VPC内のホストは規定で制限なく通信することができ、後述するゲートウェイを経由し、インターネットなどの外部ネットワークやAWSサービス通信ができる。<br />



[![Image from Gyazo](https://i.gyazo.com/a8642459b19b70be16f7cf9d1c7dfa1c.png)](https://gyazo.com/a8642459b19b70be16f7cf9d1c7dfa1c)<br />


VPCに対応するAWSサービスはプライベートネットワーク内にノードが配置できるため、外部ネットワークとのセキュリティ設計がしやすい一方、アドレス設計時にノードが使用するアドレス数のカウント・確保をしておく必要があるので注意が必要。<br />

### VPC構築に必要なネットワーク設計
データセンターやオンプレミス、オフィス拠点のネットワークアドレスと重複しないIPアドレスで構築する。理由は以下のとおり。<br />

- VPCのCIDR(IPアドレス)は後から変更不可。
- 変更にはVPC上に構築されたものを削除し再構築が必要
- 接続要件がなくても、数年後の条件変更に備える。

プライベートネットワークアドレスはRFC1918から選定し、個人的な推奨は1つのVPCに/16を割り当てる。<br />

- 10.0.0.0-10.255.255.255 (10/8 prefix)
- 172.16.0.0-172.31.255.255 (172.16/12 prefix)
- 192.168.0.0-192.168.255.255 (192.168/16 prefix)

重複する場合は、RFC6598 (100.64.0.0/10)のShared Addressの使用も検討するとよい。<br />

Amazon VPC IPアドレス設計やネットワーク設計については以下文献を参照すると良い。<br />

[Amazon VPC IPアドレス設計レシピ](https://dev.classmethod.jp/articles/vpc-cidr/)<br />

[#cmdevio2018 基礎から応用までじっくり学ぶ「AWSでのネットワークの作り方」で登壇しました。](https://dev.classmethod.jp/articles/developers-io-2018-aws-network-session/)<br />


また、IPv4/v6のディアルスタックでネットワーク構築も可能。<br />
IPv6は自動適用ではなく任意。一部非対応のものもあるので気をつけて設計する必要がある。<br />

|                             | IPv4                               | IPv6                               |
|:----------------------------|:-----------------------------------|:-----------------------------------|
| VPCでの利用                 | デフォルト利用                     | 自動適用はなく任意                 |
| CIDRブロックサイズ          | 16-28bitで選択                     | 56bit固定                          |
| サブネットブロックサイズ    | 16-28bitで選択                     | 64bit固定                          |
| パブリックIP/プライベートIP | それぞれ存在                       | パブリックのみ                     |
| インスタンスタイプ          | 全てのタイプが利用可能             | 現行世代と一部の旧世代がサポート   |
| 利用可能なVPCリソース       | CGW/VGW/NAT/VPC Endpointが利用可能 | CGW/VGW/NAT/VPC Endpointが利用不可 |

参考元: [VPCのIPアドレス指定](https://docs.aws.amazon.com/ja_jp/vpc/latest/userguide/vpc-ip-addressing.html)


### VPC Subnet (サブネット)
VPC内を分割する単位としてサブネットを設定し、EC2の仮想マシン（EC2インスタンス）やRDSのDBインスタンスをサブネットに接続して利用する。<br />
VPCのアドレス帯域内を自由に分割できるが、AWSのデータセンター群にあたるAZ（アベイラビリティゾーン）に紐づけなければならず、AZを複数跨ぐサブネットは作成できない。<br />
リージョン内の複数のAZを利用するVPCを構築するためには、AZごとに最低1つのサブネットを作成する必要がある。<br />


[![Image from Gyazo](https://i.gyazo.com/4809abf560320951f42f4461e6854c22.png)](https://gyazo.com/4809abf560320951f42f4461e6854c22)<br />


サブネットに接続するインスタンスには、DHCPによってサブネットのアドレス帯域内からプライベートIPga割り当てられる。<br />
サブネット内はTCP/IPネットワークの同一セグメントとなり、インスタンス同氏はプライベートIPを利用してレイヤ2で通信する。<br />
サブネットの2番目のIPアドレス（192.168.1.0/24であれば192.168.1.1）には、暗黙の"仮想ルーター"と呼ばれる装置が自動で接続され、DHCPによって各インスタンスのデフォルトゲートウェイに設定される。<br />
暗黙の"仮想ルーター"は、規定でVPC内の他のサブネットへの経路情報を持ち、サブネット間ではL3レベルで暗黙の"仮想ルーター"経由で通信する。<br />


[![Image from Gyazo](https://i.gyazo.com/ad2633fca15278f29092d3db93720df1.png)](https://gyazo.com/ad2633fca15278f29092d3db93720df1)<br />


オンプレミスでIP固定で利用できた人にとってはDHCPは管理しにくいが、VPCでは別サービスでプライベートDNSが簡単に利用できるのでDHCPでの利用が推奨される。<br />

### ルートテーブル

ルートテーブルは、暗黙の"仮想ルーター"の経路情報（ルーティング）設定として、サブネットごとに設定する。<br />
複数のサブネットを1つのルートテーブルで設定も可能。<br />
暗黙の"仮想ルーター"同士のVPC内経路情報は"Local"というエントリーとして設定済みで、変更することはできない。<br />
インターネットなど外部ネットワークと通信する場合に、インターネットゲートウェイ（IGW）をネクストホップとして経路情報に追加する。<br />


外部ネットワークとの通信に利用するゲートウェイは、インターネットと接続するためのインターネットゲートウェイ（IGW）とオンプレミスのネットワークと接続するための仮想プライベートゲートウェイ（VGW）を作成、構成する。<br />
IGWを経由するEC2インスタンスとインターネット間の通信のために、VPCではインスタンスごとにパブリックIPを付与する。<br />
パブリックIPはEC2インスタンスのNIC(VPCではENI=Elastic Network Interfaceと呼ぶ)に直接設定するのではなく、IGWでStatic NATを構成し、インターネットからトラフィック受信時に宛先IPアドレスであるパブリックIPをインスタンスのプライベートIPに変換することで動作する。<br />

[![Image from Gyazo](https://i.gyazo.com/4c4efdedffe59edf164adb7939790021.png)](https://gyazo.com/4c4efdedffe59edf164adb7939790021)<br />


## セキュリティ

### トラフィック制御（Secutrity Group/Network ACL）


## 参考文献
[クラスメソッド記事](https://dev.classmethod.jp/articles/re-introduction-2022-vpc/)
